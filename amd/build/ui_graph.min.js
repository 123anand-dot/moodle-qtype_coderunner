define(["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10,this.parent=b,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","id_graphcanvas_"+c),this.canvas.setAttribute("style","background-color: white"),this.canvas.setAttribute("class","coderunner_graphcanvas"),this.canvas.setAttribute("tabindex","1"),this.canvas.onmousedown=function(a){return b.mousedown(a)},this.canvas.onmouseup=function(a){return b.mouseup(a)},this.canvas.ondblclick=function(a){return b.dblclick(a)},this.canvas.onkeydown=function(a){return b.keydown(a)},this.canvas.onmousemove=function(a){return b.mousemove(a)},this.canvas.onkeypress=function(a){return b.keypress(a)},this.resize=function(b,c){this.canvas.setAttribute("width",b),this.canvas.setAttribute("height",c),a(this.canvas).css({height:c,width:b})},this.resize(d,e)}function e(b,e,f,g){this.SNAP_TO_PADDING=6,this.HIT_TARGET_PADDING=6,this.DEFAULT_NODE_RADIUS=20,this.MIN_WIDTH=400,this.MIN_HEIGHT=400,this.textArea=a(document.getElementById(b)),this.templateParams=g,this.graphCanvas=new d(this,b,e,f),this.caretVisible=!0,this.caretTimer=0,this.originalClick=null,this.nodes=[],this.links=[],this.helpBox=new c.HelpBox(this,0,0),this.helpBoxHighlighted=!1,this.selectedObject=null,this.currentLink=null,this.movingObject=!1,this.reload(),this.draw()}return e.prototype.getElement=function(){return this.getCanvas()},e.prototype.getMinSize=function(){return{minWidth:this.MIN_WIDTH,minHeight:this.MIN_HEIGHT}},e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()},e.prototype.getCanvas=function(){return this.graphCanvas.canvas},e.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS},e.prototype.isFsm=function(){return void 0===this.templateParams.isfsm||this.templateParams.isfsm},e.prototype.arrowIfReqd=function(a,c,d,e){(void 0===this.templateParams.isdirected||this.templateParams.isdirected)&&b.drawArrow(a,c,d,e)},e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);return c>=32&&c<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&"text"in this.selectedObject?(this.selectedObject.text+=String.fromCharCode(c),this.resetCaret(),this.draw(),!1):8!==c&&void 0},e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);return this.selectedObject=this.selectObject(d.x,d.y),this.movingObject=!1,this.originalClick=d,null!==this.selectedObject?(a.shiftKey&&this.selectedObject instanceof c.Node?this.currentLink=new c.SelfLink(this,this.selectedObject,d):(this.movingObject=!0,this.selectedObject.setMouseStart&&this.selectedObject.setMouseStart(d.x,d.y)),this.resetCaret()):a.shiftKey&&this.isFsm()&&(this.currentLink=new c.TemporaryLink(this,d,d)),this.draw(),!this.hasFocus()&&(this.resetCaret(),!0)},e.prototype.keydown=function(a){var c=b.crossBrowserKey(a);if(8===c)return null!==this.selectedObject&&"text"in this.selectedObject&&(this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1),this.resetCaret(),this.draw()),!1;if(46===c){if(null!==this.selectedObject){for(var d=0;d<this.nodes.length;d++)this.nodes[d]===this.selectedObject&&this.nodes.splice(d--,1);for(var d=0;d<this.links.length;d++)this.links[d]!==this.selectedObject&&this.links[d].node!==this.selectedObject&&this.links[d].nodeA!==this.selectedObject&&this.links[d].nodeB!==this.selectedObject||this.links.splice(d--,1);this.selectedObject=null,this.draw()}}else 13===c&&null!==this.selectedObject&&(this.selectedObject=null,this.draw())},e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);this.selectedObject=this.selectObject(d.x,d.y),null===this.selectedObject?(this.selectedObject=new c.Node(this,d.x,d.y),this.nodes.push(this.selectedObject),this.resetCaret(),this.draw()):this.selectedObject instanceof c.Node&&(this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState,this.draw())},e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b),this.draw()},e.prototype.mousemove=function(a){var d,e=b.crossBrowserRelativeMousePos(a),f=this.helpBox.containsPoint(e.x,e.y);if(f!=this.helpBoxHighlighted&&(this.helpBoxHighlighted=f,this.draw()),null!==this.currentLink){var g=this.selectObject(e.x,e.y);g instanceof c.Node||(g=null),null===this.selectedObject?null!==g?this.currentLink=new c.StartLink(this,g,this.originalClick):this.currentLink=new c.TemporaryLink(this,this.originalClick,e):g===this.selectedObject?this.currentLink=new c.SelfLink(this,this.selectedObject,e):null!==g?this.currentLink=new c.Link(this,this.selectedObject,g):(d=this.selectedObject.closestPointOnCircle(e.x,e.y),this.currentLink=new c.TemporaryLink(this,d,e)),this.draw()}this.movingObject&&(this.selectedObject.setAnchorPoint(e.x,e.y),this.selectedObject instanceof c.Node&&this.snapNode(this.selectedObject),this.draw())},e.prototype.mouseup=function(){this.movingObject=!1,null!==this.currentLink&&(this.currentLink instanceof c.TemporaryLink||(this.selectedObject=this.currentLink,this.links.push(this.currentLink),this.resetCaret()),this.currentLink=null,this.draw())},e.prototype.selectObject=function(a,b){if(this.helpBox.containsPoint(a,b)&&this.selectedObject!=this.helpBox)return this.helpBox;for(var c=0;c<this.nodes.length;c++)if(this.nodes[c].containsPoint(a,b))return this.nodes[c];for(var c=0;c<this.links.length;c++)if(this.links[c].containsPoint(a,b))return this.links[c];return null},e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b]!==a&&(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING&&(a.x=this.nodes[b].x),Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING&&(a.y=this.nodes[b].y))},e.prototype.reload=function(){if(JSON)try{for(var b=JSON.parse(a(this.textArea).val()),d=0;d<b.nodes.length;d++){var e=b.nodes[d],f=b.nodeGeometry[d],g=new c.Node(this,f[0],f[1]);g.isAcceptState=e[1],g.text=e[0],this.nodes.push(g)}for(var d=0;d<b.edges.length;d++){var h=b.edges[d],i=b.edgeGeometry[d],j=null;h[0]===h[1]?(j=new c.SelfLink(this,this.nodes[h[0]]),j.anchorAngle=i.anchorAngle,j.text=h[2]):h[0]===-1?(j=new c.StartLink(this,this.nodes[h[1]]),j.deltaX=i.deltaX,j.deltaY=i.deltaY):(j=new c.Link(this,this.nodes[h[0]],this.nodes[h[1]]),j.parallelPart=i.parallelPart,j.perpendicularPart=i.perpendicularPart,j.text=h[2],j.lineAngleAdjust=i.lineAngleAdjust),null!==j&&this.links.push(j)}}catch(k){}},e.prototype.save=function(){if(JSON){for(var b={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},d=0;d<this.nodes.length;d++){var e=this.nodes[d],f=[e.text,e.isAcceptState],g=[e.x,e.y];b.nodeGeometry.push(g),b.nodes.push(f)}for(var d=0;d<this.links.length;d++){var h=this.links[d],i=null,j=null;h instanceof c.SelfLink?(j={anchorAngle:h.anchorAngle},i=[this.nodes.indexOf(h.node),this.nodes.indexOf(h.node),h.text]):h instanceof c.StartLink?(j={deltaX:h.deltaX,deltaY:h.deltaY},i=[-1,this.nodes.indexOf(h.node),""]):h instanceof c.Link&&(j={lineAngleAdjust:h.lineAngleAdjust,parallelPart:h.parallelPart,perpendicularPart:h.perpendicularPart},i=[this.nodes.indexOf(h.nodeA),this.nodes.indexOf(h.nodeB),h.text]),null!==i&&null!==j&&(b.edges.push(i),b.edgeGeometry.push(j))}a(this.textArea).val(JSON.stringify(b))}},e.prototype.destroy=function(){this.getCanvas().remove()},e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer),this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible,a.draw()},500),this.caretVisible=!0},e.prototype.draw=function(){var a=this.getCanvas().getContext("2d");if(a.clearRect(0,0,this.getCanvas().width,this.getCanvas().height),a.save(),a.translate(.5,.5),this.helpBox.draw(a,this.selectedObject==this.helpBox,this.helpBoxHighlighted),this.selectedObject!=this.helpBox){for(var b=0;b<this.nodes.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=this.nodes[b]===this.selectedObject?"blue":"black",this.nodes[b].draw(a);for(var b=0;b<this.links.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=this.links[b]===this.selectedObject?"blue":"black",this.links[b].draw(a);null!==this.currentLink&&(a.lineWidth=1,a.fillStyle=a.strokeStyle="black",this.currentLink.draw(a))}a.restore(),this.save()},e.prototype.drawText=function(a,c,d,e,f){var g,h=this.getCanvas().getContext("2d"),i=b.convertLatexShortcuts(a);if(h.font="20px Arial",g=h.measureText(i).width,c-=g/2,null!==e){var j=Math.cos(e),k=Math.sin(e),l=(g/2+5)*(j>0?1:-1),m=15*(k>0?1:-1),n=k*Math.pow(Math.abs(k),40)*l-j*Math.pow(Math.abs(j),10)*m;c+=l-k*n,d+=m+j*n}"advancedFillText"in h?h.advancedFillText(i,a,c+g/2,d,e):(c=Math.round(c),d=Math.round(d),h.fillText(i,c,d+6),f==this.selectedObject&&this.caretVisible&&this.hasFocus()&&document.hasFocus()&&(c+=g,h.beginPath(),h.moveTo(c,d-10),h.lineTo(c,d+10),h.stroke()))},{Constructor:e}});