define(["jquery","qtype_coderunner/graphutil","qtype_coderunner/graphelements"],function(a,b,c){function d(b,c,d,e){this.HANDLE_SIZE=10,this.parent=b,this.canvas=a(document.createElement("canvas")),this.canvas.attr({id:c,"class":"coderunner_graphcanvas",tabindex:1}),this.canvas.css({"background-color":"white"}),this.canvas.on("mousedown",function(a){return b.mousedown(a)}),this.canvas.on("mouseup",function(a){return b.mouseup(a)}),this.canvas.on("dblclick",function(a){return b.dblclick(a)}),this.canvas.on("keydown",function(a){return b.keydown(a)}),this.canvas.on("mousemove",function(a){return b.mousemove(a)}),this.canvas.on("keypress",function(a){return b.keypress(a)}),this.resize=function(a,b){this.canvas.attr("width",a),this.canvas.attr("height",b),this.canvas.css({height:b,width:a})},this.resize(d,e)}function e(b,e,f,g){this.SNAP_TO_PADDING=6,this.HIT_TARGET_PADDING=6,this.DEFAULT_NODE_RADIUS=26,this.MIN_WIDTH=400,this.MIN_HEIGHT=400,this.canvasId="graphcanvas_"+b,this.textArea=a(document.getElementById(b)),this.readOnly=this.textArea.prop("readonly"),this.templateParams=g,this.graphCanvas=new d(this,this.canvasId,e,f),this.caretVisible=!0,this.caretTimer=0,this.originalClick=null,this.nodes=[],this.links=[],this.helpBox=new c.HelpBox(this,0,0),this.helpBoxHighlighted=!1,this.selectedObject=null,this.currentLink=null,this.movingObject=!1,this.fail=!1,this.reload(),this.failed||this.draw()}return e.prototype.failed=function(){return this.fail},e.prototype.getElement=function(){return this.getCanvas()},e.prototype.getMinSize=function(){return{minWidth:this.MIN_WIDTH,minHeight:this.MIN_HEIGHT}},e.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()},e.prototype.getCanvas=function(){var a=this.graphCanvas.canvas[0];return a},e.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS},e.prototype.isFsm=function(){return void 0===this.templateParams.isfsm||this.templateParams.isfsm},e.prototype.arrowIfReqd=function(a,c,d,e){(void 0===this.templateParams.isdirected||this.templateParams.isdirected)&&b.drawArrow(a,c,d,e)},e.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(!this.readOnly)return c>=32&&c<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&"text"in this.selectedObject?(this.selectedObject.text+=String.fromCharCode(c),this.resetCaret(),this.draw(),!1):8!==c&&32!==c&&9!==c&&void 0},e.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(!this.readOnly)return this.selectedObject=this.selectObject(d.x,d.y),this.movingObject=!1,this.originalClick=d,null!==this.selectedObject?(a.shiftKey&&this.selectedObject instanceof c.Node?this.currentLink=new c.SelfLink(this,this.selectedObject,d):(this.movingObject=!0,this.selectedObject.setMouseStart&&this.selectedObject.setMouseStart(d.x,d.y)),this.resetCaret()):a.shiftKey&&this.isFsm()&&(this.currentLink=new c.TemporaryLink(this,d,d)),this.draw(),!this.hasFocus()&&(this.resetCaret(),!0)},e.prototype.keydown=function(a){var c=b.crossBrowserKey(a);if(!this.readOnly){if(8===c)return null!==this.selectedObject&&"text"in this.selectedObject&&(this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1),this.resetCaret(),this.draw()),!1;if(46===c){if(null!==this.selectedObject){for(var d=0;d<this.nodes.length;d++)this.nodes[d]===this.selectedObject&&this.nodes.splice(d--,1);for(var d=0;d<this.links.length;d++)this.links[d]!==this.selectedObject&&this.links[d].node!==this.selectedObject&&this.links[d].nodeA!==this.selectedObject&&this.links[d].nodeB!==this.selectedObject||this.links.splice(d--,1);this.selectedObject=null,this.draw()}}else 13===c&&null!==this.selectedObject&&(this.selectedObject=null,this.draw())}},e.prototype.dblclick=function(a){var d=b.crossBrowserRelativeMousePos(a);this.readOnly||(this.selectedObject=this.selectObject(d.x,d.y),null===this.selectedObject?(this.selectedObject=new c.Node(this,d.x,d.y),this.nodes.push(this.selectedObject),this.resetCaret(),this.draw()):this.selectedObject instanceof c.Node&&(this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState,this.draw()))},e.prototype.resize=function(a,b){this.graphCanvas.resize(a,b),this.draw()},e.prototype.mousemove=function(a){var d,e=b.crossBrowserRelativeMousePos(a),f=this.helpBox.containsPoint(e.x,e.y);if(!this.readOnly){if(f!=this.helpBoxHighlighted&&(this.helpBoxHighlighted=f,this.draw()),null!==this.currentLink){var g=this.selectObject(e.x,e.y);g instanceof c.Node||(g=null),null===this.selectedObject?null!==g?this.currentLink=new c.StartLink(this,g,this.originalClick):this.currentLink=new c.TemporaryLink(this,this.originalClick,e):g===this.selectedObject?this.currentLink=new c.SelfLink(this,this.selectedObject,e):null!==g?this.currentLink=new c.Link(this,this.selectedObject,g):(d=this.selectedObject.closestPointOnCircle(e.x,e.y),this.currentLink=new c.TemporaryLink(this,d,e)),this.draw()}this.movingObject&&(this.selectedObject.setAnchorPoint(e.x,e.y),this.selectedObject instanceof c.Node&&this.snapNode(this.selectedObject),this.draw())}},e.prototype.mouseup=function(){this.readOnly||(this.movingObject=!1,null!==this.currentLink&&(this.currentLink instanceof c.TemporaryLink||(this.selectedObject=this.currentLink,this.links.push(this.currentLink),this.resetCaret()),this.currentLink=null,this.draw()))},e.prototype.selectObject=function(a,b){if(this.helpBox.containsPoint(a,b)&&this.selectedObject!=this.helpBox)return this.helpBox;for(var c=0;c<this.nodes.length;c++)if(this.nodes[c].containsPoint(a,b))return this.nodes[c];for(var c=0;c<this.links.length;c++)if(this.links[c].containsPoint(a,b))return this.links[c];return null},e.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b]!==a&&(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING&&(a.x=this.nodes[b].x),Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING&&(a.y=this.nodes[b].y))},e.prototype.reload=function(){var b=a(this.textArea).val(),d=M.util.get_string("graphfail","qtype_coderunner");if(b)try{for(var e=JSON.parse(b),f=0;f<e.nodes.length;f++){var g=e.nodes[f],h=e.nodeGeometry[f],i=new c.Node(this,h[0],h[1]);i.isAcceptState=g[1],i.text=g[0],this.nodes.push(i)}for(var f=0;f<e.edges.length;f++){var j=e.edges[f],k=e.edgeGeometry[f],l=null;j[0]===j[1]?(l=new c.SelfLink(this,this.nodes[j[0]]),l.anchorAngle=k.anchorAngle,l.text=j[2]):j[0]===-1?(l=new c.StartLink(this,this.nodes[j[1]]),l.deltaX=k.deltaX,l.deltaY=k.deltaY):(l=new c.Link(this,this.nodes[j[0]],this.nodes[j[1]]),l.parallelPart=k.parallelPart,l.perpendicularPart=k.perpendicularPart,l.text=j[2],l.lineAngleAdjust=k.lineAngleAdjust),null!==l&&this.links.push(l)}}catch(m){alert(d),this.fail=!0}},e.prototype.save=function(){var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]};if(JSON&&(""!==this.textArea.val().trim()||0!==this.nodes.length)){for(var b=0;b<this.nodes.length;b++){var d=this.nodes[b],e=[d.text,d.isAcceptState],f=[d.x,d.y];a.nodeGeometry.push(f),a.nodes.push(e)}for(var b=0;b<this.links.length;b++){var g=this.links[b],h=null,i=null;g instanceof c.SelfLink?(i={anchorAngle:g.anchorAngle},h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.text]):g instanceof c.StartLink?(i={deltaX:g.deltaX,deltaY:g.deltaY},h=[-1,this.nodes.indexOf(g.node),""]):g instanceof c.Link&&(i={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart},h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.text]),null!==h&&null!==i&&(a.edges.push(h),a.edgeGeometry.push(i))}this.textArea.val(JSON.stringify(a))}},e.prototype.destroy=function(){clearInterval(this.caretTimer),this.graphCanvas.canvas.off(),this.graphCanvas.canvas.remove()},e.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer),this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible,a.draw()},500),this.caretVisible=!0},e.prototype.draw=function(){var a=this.getCanvas(),b=a.getContext("2d");if(b.clearRect(0,0,this.getCanvas().width,this.getCanvas().height),b.save(),b.translate(.5,.5),this.helpBox.draw(b,this.selectedObject==this.helpBox,this.helpBoxHighlighted),this.selectedObject!=this.helpBox){for(var c=0;c<this.nodes.length;c++)b.lineWidth=1,b.fillStyle=b.strokeStyle=this.nodes[c]===this.selectedObject?"blue":"black",this.nodes[c].draw(b);for(var c=0;c<this.links.length;c++)b.lineWidth=1,b.fillStyle=b.strokeStyle=this.links[c]===this.selectedObject?"blue":"black",this.links[c].draw(b);null!==this.currentLink&&(b.lineWidth=1,b.fillStyle=b.strokeStyle="black",this.currentLink.draw(b))}b.restore(),this.save()},e.prototype.drawText=function(a,c,d,e,f){var g,h=this.getCanvas().getContext("2d"),i=b.convertLatexShortcuts(a);if(h.font="20px Arial",g=h.measureText(i).width,c-=g/2,null!==e){var j=Math.cos(e),k=Math.sin(e),l=(g/2+5)*(j>0?1:-1),m=15*(k>0?1:-1),n=k*Math.pow(Math.abs(k),40)*l-j*Math.pow(Math.abs(j),10)*m;c+=l-k*n,d+=m+j*n}"advancedFillText"in h?h.advancedFillText(i,a,c+g/2,d,e):(c=Math.round(c),d=Math.round(d),h.fillText(i,c,d+6),f==this.selectedObject&&this.caretVisible&&this.hasFocus()&&document.hasFocus()&&(c+=g,h.beginPath(),h.moveTo(c,d-10),h.lineTo(c,d+10),h.stroke()))},{Constructor:e}});