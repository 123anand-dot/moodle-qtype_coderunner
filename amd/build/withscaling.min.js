define(["jquery"],function(a){function b(a,b){this.nodeA=a,this.nodeB=b,this.text="",this.lineAngleAdjust=0,this.parallelPart=.5,this.perpendicularPart=0}function c(a,b){this.x=a/z,this.y=b/A,this.mouseOffsetX=0,this.mouseOffsetY=0,this.isAcceptState=!1,this.text=""}function d(a,b){this.node=a,this.anchorAngle=0,this.mouseOffsetAngle=0,this.text="",b&&this.setAnchorPoint(b.x,b.y)}function e(a,b){this.node=a,this.deltaX=0,this.deltaY=0,b&&this.setAnchorPoint(b.x,b.y)}function f(a,b){this.from={x:a.x/z,y:a.y/A},this.to={x:b.x/z,y:b.y/A}}function g(a){for(var b=0;b<G.length;b++){var c=G[b];a=a.replace(new RegExp("\\\\"+c,"g"),String.fromCharCode(913+b+(b>16))),a=a.replace(new RegExp("\\\\"+c.toLowerCase(),"g"),String.fromCharCode(945+b+(b>16)))}for(var b=0;b<10;b++)a=a.replace(new RegExp("_"+b,"g"),String.fromCharCode(8320+b));return a}function h(a,b,c,d){var e=Math.cos(d),f=Math.sin(d);a.beginPath(),a.moveTo(b,c),a.lineTo(b-8*e+5*f,c-8*f-5*e),a.lineTo(b-8*e-5*f,c-8*f+5*e),a.fill()}function i(){return(document.activeElement||document.body)===document.body}function j(a,b,c,d,e,f){var h=g(b),j=1/30*A;a.font=j+'px "Times New Roman", serif';var k=a.measureText(h).width;if(c-=k/2,null!==e){var l=Math.cos(e),m=Math.sin(e),n=(k/2+5)*(l>0?1:-1),o=15*(m>0?1:-1),p=m*Math.pow(Math.abs(m),40)*n-l*Math.pow(Math.abs(l),10)*o;c+=n-m*p,d+=o+l*p}"advancedFillText"in a?a.advancedFillText(h,b,c+k/2,d,e):(c=Math.round(c),d=Math.round(d),a.fillText(h,c,d+6),f&&H&&i()&&document.hasFocus()&&(c+=k,a.beginPath(),a.moveTo(c,d-10),a.lineTo(c,d+10),a.stroke()))}function k(){clearInterval(C),C=setInterval(function(){H=!H,n()},500),H=!0}function l(a){a.beginPath(),a.fillStyle="rgba(119,136,153,0.5)",a.fillRect(z-50,0,50,25),a.lineWidth=2,a.strokeStyle="#000000",a.stroke(),a.closePath(),a.font='12pt "Times New Roman", serif',a.fillStyle="#000000",a.textAlign="center",a.fillText("Help",z-25,17),a.textAlign="left"}function m(a){a.clearRect(0,0,D.width,D.height),a.save(),a.translate(.5,.5),l(a);for(var b=0;b<I.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=I[b]===N?"blue":"black",I[b].draw(a);for(var b=0;b<J.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=J[b]===N?"blue":"black",J[b].draw(a);null!==O&&(a.lineWidth=1,a.fillStyle=a.strokeStyle="black",O.draw(a)),a.restore()}function n(){m(D.getContext("2d")),x()}function o(a,b){for(var c=0;c<I.length;c++)if(I[c].containsPoint(a,b))return I[c];for(var c=0;c<J.length;c++)if(J[c].containsPoint(a,b))return J[c];return null}function p(a){for(var b=0;b<I.length;b++)I[b]!==a&&(Math.abs((a.x-I[b].x)*z)<K&&(a.x=I[b].x),Math.abs((a.y-I[b].y)*A)<K&&(a.y=I[b].y))}function q(a){return a=a||window.event,a.which||a.keyCode}function r(a){a=a||window.event;for(var b=a.target||a.srcElement,c=0,d=0;b.offsetParent;)c+=b.offsetLeft,d+=b.offsetTop,b=b.offsetParent;return{x:c,y:d}}function s(a){return a=a||window.event,{x:a.pageX||a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:a.pageY||a.clientY+document.body.scrollTop+document.documentElement.scrollTop}}function t(a){var b=r(a),c=s(a);return{x:c.x-b.x,y:c.y-b.y}}function u(a,b,c,d,e,f,g,h,i){return a*e*i+b*f*g+c*d*h-a*f*h-b*d*i-c*e*g}function v(a,b,c,d,e,f){var g=u(a,b,1,c,d,1,e,f,1),h=-u(a*a+b*b,b,1,c*c+d*d,d,1,e*e+f*f,f,1),i=u(a*a+b*b,a,1,c*c+d*d,c,1,e*e+f*f,e,1),j=-u(a*a+b*b,a,b,c*c+d*d,c,d,e*e+f*f,e,f);return{x:-h/(2*g),y:-i/(2*g),radius:Math.sqrt(h*h+i*i-4*g*j)/(2*Math.abs(g))}}function w(){if(JSON)try{for(var a=JSON.parse(y.val()),f=0;f<a.nodes.length;f++){var g=a.nodes[f],h=a.nodeGeometry[f],i=new c(h[0]*z,h[1]*A);i.isAcceptState=g[1],i.text=g[0],I.push(i)}for(var f=0;f<a.edges.length;f++){var j=a.edges[f],k=a.edgeGeometry[f],l=null;j[0]===j[1]?(l=new d(I[j[0]]),l.anchorAngle=k.anchorAngle,l.text=j[2]):j[0]===-1?(l=new e(I[j[1]]),l.deltaX=k.deltaX,l.deltaY=k.deltaY):(l=new b(I[j[0]],I[j[1]]),l.parallelPart=k.parallelPart,l.perpendicularPart=k.perpendicularPart,l.text=j[2],l.lineAngleAdjust=k.lineAngleAdjust),null!==l&&J.push(l)}}catch(m){}}function x(){if(JSON){for(var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},c=0;c<I.length;c++){var f=I[c],g=[f.text,f.isAcceptState],h=[f.x,f.y];a.nodeGeometry.push(h),a.nodes.push(g)}for(var c=0;c<J.length;c++){var i=J[c],j=null,k=null;i instanceof d?(k={anchorAngle:i.anchorAngle},j=[I.indexOf(i.node),I.indexOf(i.node),i.text]):i instanceof e?(k={deltaX:i.deltaX,deltaY:i.deltaY},j=[-1,I.indexOf(i.node),""]):i instanceof b&&(k={lineAngleAdjust:i.lineAngleAdjust,parallelPart:i.parallelPart,perpendicularPart:i.perpendicularPart},j=[I.indexOf(i.nodeA),I.indexOf(i.nodeB),i.text]),null!==j&&null!==k&&(a.edges.push(j),a.edgeGeometry.push(k))}y.val(JSON.stringify(a))}}var y,z,A,B={x:z,y:0,width:50,height:25};b.prototype.getAnchorPoint=function(){var a=this.nodeA.x*z,b=this.nodeB.x*z,c=this.nodeA.y*A,d=this.nodeB.y*A,e=b-a,f=d-c,g=Math.sqrt(e*e+f*f);return{x:a+e*this.parallelPart-f*this.perpendicularPart/g,y:c+f*this.parallelPart+e*this.perpendicularPart/g}},b.prototype.setAnchorPoint=function(a,b){var c=this.nodeA.x*z,d=this.nodeB.x*z,e=this.nodeA.y*A,f=this.nodeB.y*A,g=d-c,h=f-e,i=Math.sqrt(g*g+h*h);this.parallelPart=(g*(a-c)+h*(b-e))/(i*i),this.perpendicularPart=(g*(b-e)-h*(a-c))/i,this.parallelPart>0&&this.parallelPart<1&&Math.abs(this.perpendicularPart)<K&&(this.lineAngleAdjust=(this.perpendicularPart<0)*Math.PI,this.perpendicularPart=0)},b.prototype.getEndPointsAndCircle=function(){var a=this.nodeA.x*z,b=this.nodeB.x*z,c=this.nodeA.y*A,d=this.nodeB.y*A;if(0===this.perpendicularPart){var e=(a+b)/2,f=(c+d)/2,g=this.nodeA.closestPointOnCircle(e,f),h=this.nodeB.closestPointOnCircle(e,f);return{hasCircle:!1,startX:g.x,startY:g.y,endX:h.x,endY:h.y}}var i=this.getAnchorPoint(),j=v(a,c,b,d,i.x,i.y),k=this.perpendicularPart>0,l=k?1:-1,m=Math.atan2(c-j.y,a-j.x)-l*E/j.radius,n=Math.atan2(d-j.y,b-j.x)+l*E/j.radius,o=j.x+j.radius*Math.cos(m),p=j.y+j.radius*Math.sin(m),q=j.x+j.radius*Math.cos(n),r=j.y+j.radius*Math.sin(n);return{hasCircle:!0,startX:o,startY:p,endX:q,endY:r,startAngle:m,endAngle:n,circleX:j.x,circleY:j.y,circleRadius:j.radius,reverseScale:l,isReversed:k}},b.prototype.draw=function(a){var b=this.getEndPointsAndCircle();if(a.beginPath(),b.hasCircle?a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,b.isReversed):(a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY)),a.stroke(),b.hasCircle?h(a,b.endX,b.endY,b.endAngle-b.reverseScale*(Math.PI/2)):h(a,b.endX,b.endY,Math.atan2(b.endY-b.startY,b.endX-b.startX)),b.hasCircle){var c=b.startAngle,d=b.endAngle;d<c&&(d+=2*Math.PI);var e=(c+d)/2+b.isReversed*Math.PI,f=b.circleX+b.circleRadius*Math.cos(e),g=b.circleY+b.circleRadius*Math.sin(e);j(a,this.text,f,g,e,N===this)}else{var f=(b.startX+b.endX)/2,g=(b.startY+b.endY)/2,e=Math.atan2(b.endX-b.startX,b.startY-b.endY);j(a,this.text,f,g,e+this.lineAngleAdjust,N===this)}},b.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle();if(!c.hasCircle){var d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<L}var d=a-c.circleX,e=b-c.circleY,h=Math.sqrt(d*d+e*e)-c.circleRadius;if(Math.abs(h)<L){var i=Math.atan2(e,d),j=c.startAngle,k=c.endAngle;if(c.isReversed){var l=j;j=k,k=l}return k<j&&(k+=2*Math.PI),i<j?i+=2*Math.PI:i>k&&(i-=2*Math.PI),i>j&&i<k}return!1},c.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.x-a/z,this.mouseOffsetY=this.y-b/A},c.prototype.setAnchorPoint=function(a,b){this.x=a/z+this.mouseOffsetX,this.y=b/A+this.mouseOffsetY},c.prototype.draw=function(a){var b=this.x*z,c=this.y*A;a.beginPath(),a.arc(b,c,E,0,2*Math.PI,!1),a.stroke(),j(a,this.text,b,c,null,N===this),this.isAcceptState&&(a.beginPath(),a.arc(b,c,E-6,0,2*Math.PI,!1),a.stroke())},c.prototype.closestPointOnCircle=function(a,b){var c=a-this.x*z,d=b-this.y*A,e=Math.sqrt(c*c+d*d);return{x:this.x*z+c*E/e,y:this.y*A+d*E/e}},c.prototype.containsPoint=function(a,b){var c=a-this.x*z,d=b-this.y*A;return c*c+d*d<E*E},d.prototype.setMouseStart=function(a,b){var c=b/A-this.node.y,d=a/z-this.node.x;this.mouseOffsetAngle=this.anchorAngle-Math.atan2(c,d)},d.prototype.setAnchorPoint=function(a,b){var c=this.node.y,d=this.node.x;a/=z,b/=A,this.anchorAngle=Math.atan2((b-c)*A,(a-d)*z)+this.mouseOffsetAngle;var e=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);Math.abs(this.anchorAngle-e)<.1&&(this.anchorAngle=e),this.anchorAngle<-Math.PI&&(this.anchorAngle+=2*Math.PI),this.anchorAngle>Math.PI&&(this.anchorAngle-=2*Math.PI)},d.prototype.getEndPointsAndCircle=function(){var a=this.node.x*z+1.5*E*Math.cos(this.anchorAngle),b=this.node.y*A+1.5*E*Math.sin(this.anchorAngle),c=.75*E,d=this.anchorAngle-.8*Math.PI,e=this.anchorAngle+.8*Math.PI,f=a+c*Math.cos(d),g=b+c*Math.sin(d),h=a+c*Math.cos(e),i=b+c*Math.sin(e);return{hasCircle:!0,startX:f,startY:g,endX:h,endY:i,startAngle:d,endAngle:e,circleX:a,circleY:b,circleRadius:c}},d.prototype.draw=function(a){var b=this.getEndPointsAndCircle();a.beginPath(),a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,!1),a.stroke();var c=b.circleX+b.circleRadius*Math.cos(this.anchorAngle),d=b.circleY+b.circleRadius*Math.sin(this.anchorAngle);j(a,this.text,c,d,this.anchorAngle,N===this),h(a,b.endX,b.endY,b.endAngle+.4*Math.PI)},d.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d=a-c.circleX,e=b-c.circleY,f=Math.sqrt(d*d+e*e)-c.circleRadius;return Math.abs(f)<L},e.prototype.setAnchorPoint=function(a,b){this.deltaX=a-this.node.x*z,this.deltaY=b-this.node.y*A,Math.abs(this.deltaX)<K&&(this.deltaX=0),Math.abs(this.deltaY)<K&&(this.deltaY=0)},e.prototype.getEndPoints=function(){var a=this.node.x*z+this.deltaX,b=this.node.y*A+this.deltaY,c=this.node.closestPointOnCircle(a,b);return{startX:a,startY:b,endX:c.x,endY:c.y}},e.prototype.draw=function(a){var b=this.getEndPoints();a.beginPath(),a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY),a.stroke(),h(a,b.endX,b.endY,Math.atan2(-this.deltaY,-this.deltaX))},e.prototype.containsPoint=function(a,b){var c=this.getEndPoints(),d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<L},f.prototype.draw=function(a){var b=this.to.x*z,c=this.to.y*A,d=this.from.x*z,e=this.from.y*A;a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke(),h(a,b,c,Math.atan2(c-e,b-d))};var C,D,E,F,G=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"],H=!0,I=[],J=[],K=6,L=6,N=null,O=null,P=!1,Q=!1;document.onkeydown=function(a){var b=q(a);if(16===b)Q=!0;else{if(!i())return!0;if(8===b)return null!==N&&"text"in N&&(N.text=N.text.substr(0,N.text.length-1),k(),n()),!1;if(46===b){if(null!==N){for(var c=0;c<I.length;c++)I[c]===N&&I.splice(c--,1);for(var c=0;c<J.length;c++)J[c]!==N&&J[c].node!==N&&J[c].nodeA!==N&&J[c].nodeB!==N||J.splice(c--,1);N=null,n()}}else 13===b&&null!==N&&(N=null,n())}},document.onkeyup=function(a){var b=q(a);16===b&&(Q=!1)},document.onkeypress=function(a){var b=q(a);return!i()||(b>=32&&b<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==N&&"text"in N?(N.text+=String.fromCharCode(b),k(),n(),!1):8!==b&&void 0)};var R=function(){a(document.body).on("keydown",function(b){var c=77;b.keyCode===c&&b.ctrlKey&&b.altKey&&(a(D).toggle(),a(y).toggle())})},S=function(a,b){return a.x>b.x&&a.x<b.x+b.width&&a.y<b.y+b.height&&a.y>b.y};R.prototype.stop=function(){D=document.getElementById("canvas"),D.parentNode.removeChild(D)};var T=function(){var b=a(D).parent().width(),c=.75*b;D.setAttribute("width",b),D.setAttribute("height",c),z=b,A=c,E=.05*z,B.x=z-50,n()};return R.prototype.init=function(g){y=a(document.getElementById(g)),D=document.createElement("canvas"),D.setAttribute("id","canvas"),D.setAttribute("style","background-color: white"),a(D).insertBefore(y),z=a(D).parent().width(),A=.75*z,E=.05*z,B.x=z-50,D.setAttribute("width",z),D.setAttribute("height",A),a(y).hide(),w(),n(),window.addEventListener("resize",T,!1),D.onmousedown=function(a){var b=t(a);if(N=o(b.x,b.y),P=!1,F=b,S(b,B)){var e=M.util.get_string("fsmhelp","qtype_coderunner");alert(e)}return null!==N?(Q&&N instanceof c?O=new d(N,b):(P=!0,N.setMouseStart&&N.setMouseStart(b.x,b.y)),k()):Q&&(O=new f(b,b)),n(),!i()&&(k(),!0)},D.ondblclick=function(a){var b=t(a);N=o(b.x,b.y),null===N?(N=new c(b.x,b.y),I.push(N),k(),n()):N instanceof c&&(N.isAcceptState=!N.isAcceptState,n())},D.onmousemove=function(a){var g=t(a);if(null!==O){var h=o(g.x,g.y);h instanceof c||(h=null),O=null===N?null!==h?new e(h,F):new f(F,g):h===N?new d(N,g):null!==h?new b(N,h):new f(N.closestPointOnCircle(g.x,g.y),g),n()}P&&(N.setAnchorPoint(g.x,g.y),N instanceof c&&p(N),n())},D.onmouseup=function(){P=!1,null!==O&&(O instanceof f||(N=O,J.push(O),k()),O=null,n())}},new R});