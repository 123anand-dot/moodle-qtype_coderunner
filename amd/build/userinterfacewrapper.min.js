define(["jquery"],function(a){function b(b,c,d,e){var f,g=this;this.MIN_WIDTH=400,this.MIN_HEIGHT=100,this.GUTTER=14,this.taId=c,this.textArea=a(document.getElementById(c)),this.readOnly=this.textArea.prop("readonly"),d?this.templateParams=window.JSON.parse(d):this.templateParams={},f=parseInt(this.textArea.css("height")),this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>"),this.wrapperNode.css({resize:"vertical",overflow:"hidden",height:f,width:"100%",border:"1px solid darkgrey"}),this.uiInstance=null,this.loadUi(b,e),a(document).mousemove(function(){g.checkForResize()}),a(window).resize(function(){g.checkForResize()}),a(document.body).on("keydown",function(a){var b=77;a.keyCode===b&&a.ctrlKey&&a.altKey&&(null!==g.uiInstance?g.stop():g.restart())})}function c(a,c,d,e){return new b(a,c,d,e)}return b.prototype.loadUi=function(a,b){var c=this;this.stop(),this.uiname=a,this.lang=b,""===this.uiname||"none"===this.uiname?this.uiInstance=null:require(["qtype_coderunner/ui_"+this.uiname],function(a){var b,d,e,f,g;e=c.wrapperNode.outerHeight(),f=e-c.GUTTER,g=c.wrapperNode.outerWidth(),d=new a.Constructor(c.taId,g,f,c.templateParams,c.lang),d.fail()?(d.destroy(),c.wrapperNode.hide(),c.uiInstance=null):(c.textArea.after(c.wrapperNode),b=d.getMinSize(),c.wrapperNode.css({minWidth:b.minWidth,minHeight:b.minHeight+c.GUTTER}),c.hLast=e,c.wLast=g,c.wrapperNode.append(d.getElement()),c.textArea.hide(),c.wrapperNode.show(),c.checkForResize(),c.uiInstance=d)})},b.prototype.stop=function(){null!==this.uiInstance&&(this.textArea.show(),this.uiInstance.hasFocus()&&(this.textArea.focus(),this.textArea[0].selectionStart=this.textArea[0].value.length),this.uiInstance.destroy(),this.uiInstance=null,this.wrapperNode.hide())},b.prototype.restart=function(){null===this.uiInstance&&this.loadUi(this.uiname,this.lang),this.wrapperNode.show()},b.prototype.checkForResize=function(){var a,b;this.uiInstance&&(a=this.wrapperNode.outerHeight(),b=this.wrapperNode.outerWidth(),a=Math.max(this.MIN_HEIGHT,a),b=Math.max(this.MIN_WIDTH,b),(a!==this.hLast||b!==this.wLast&&this.uiInstance)&&(this.uiInstance.resize(b,a-this.GUTTER),this.hLast=a,this.wLast=b))},{newUiWrapper:c}});