define(["jquery"],function(a){function b(b,c,d){var e,f=this;this.MIN_WIDTH=400,this.MIN_HEIGHT=100,this.GUTTER=14,this.taId=c,this.textArea=a(document.getElementById(c)),this.readOnly=this.textArea.prop("readonly"),this.isLoading=!1,this.loadFailed=!1,this.retries=0,e=parseInt(this.textArea.css("height")),this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>"),this.textArea.after(this.wrapperNode),this.wrapperNode.hide(),this.wrapperNode.css({resize:"vertical",overflow:"hidden",height:e,width:"auto",border:"1px solid darkgrey"}),this.textArea.data("current-ui-wrapper",this),this.uiInstance=null,this.loadUi(b,d),a(document).mousemove(function(){f.checkForResize()}),a(window).resize(function(){f.checkForResize()}),a(document.body).on("keydown",function(a){var b=77;a.keyCode===b&&a.ctrlKey&&a.altKey&&(null!==f.uiInstance||f.loadFailed?f.stop():f.restart())})}function c(a,c,d,e){var f;try{f=window.JSON.parse(d)}catch(g){f={}}return e&&(f.lang=e),a?new b(a,c,f):null}return b.prototype.loadUi=function(a,b){var c=this;return this.isLoading?(this.retries+=1,void(this.retries>20?(alert("Failed to load UI component. If this error persists, please report it to the forum on coderunner.org.nz"),this.retries=0,this.loading=0):setTimeout(function(){c.loadUi(a,b)},200))):(this.retries=0,this.params=b,this.stop(),this.uiname=a,void(""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")?this.uiInstance=null:(this.isLoading=!0,require(["qtype_coderunner/ui_"+this.uiname],function(a){var d,e,f,g;f=c.wrapperNode.innerHeight()-c.GUTTER,g=c.wrapperNode.innerWidth(),e=new a.Constructor(c.taId,g,f,b),e.failed()?(c.wrapperNode.hide(),e.destroy(),c.uiInstance=null,c.loadFailed=!0,c.textArea.addClass("uiloadfailed")):(d=e.getMinSize(),c.wrapperNode.css({minWidth:d.minWidth,minHeight:d.minHeight+c.GUTTER}),c.hLast=0,c.wLast=0,c.wrapperNode.append(e.getElement()),c.textArea.removeClass("uiloadfailed"),c.textArea.hide(),c.wrapperNode.show(),c.uiInstance=e,c.loadFailed=!1,c.checkForResize()),c.isLoading=!1}))))},b.prototype.stop=function(){null!==this.uiInstance&&(this.textArea.show(),this.uiInstance.hasFocus()&&(this.textArea.focus(),this.textArea[0].selectionStart=this.textArea[0].value.length),this.uiInstance.destroy(),this.uiInstance=null,this.wrapperNode.hide()),this.loadFailed=!1,this.textArea.removeClass("uiloadfailed")},b.prototype.restart=function(){null===this.uiInstance&&this.loadUi(this.uiname,this.params)},b.prototype.checkForResize=function(){var b,c,d,e,f,g,h=25;this.uiInstance&&(b=this.wrapperNode.innerHeight(),d=this.wrapperNode.innerWidth(),f=this.wrapperNode.offset().left,g=a(window).innerWidth()-f-h,c=Math.max(this.MIN_HEIGHT,b)-this.GUTTER,e=Math.max(this.MIN_WIDTH,Math.min(g,d)),(c!==this.hLast||e!==this.wLast&&this.uiInstance)&&(this.uiInstance.resize(e,c),this.hLast=c,this.wLast=e))},{newUiWrapper:c,InterfaceWrapper:b}});