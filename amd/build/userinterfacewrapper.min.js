define(["jquery"],function(a){function b(b,c,d,e){var f,g=this;this.MIN_WIDTH=400,this.MIN_HEIGHT=100,this.GUTTER=14,this.taId=c,this.textArea=a(document.getElementById(c)),this.readOnly=this.textArea.prop("readonly"),d?this.templateParams=window.JSON.parse(d):this.templateParams={},f=parseInt(this.textArea.css("height")),this.wrapperNode=a("<div id='"+this.taId+"_wrapper' class='ui_wrapper'></div>"),this.textArea.after(this.wrapperNode),this.wrapperNode.hide(),this.wrapperNode.css({resize:"vertical",overflow:"hidden",height:f,width:"auto",border:"1px solid darkgrey"}),this.uiInstance=null,this.loadUi(b,e),a(document).mousemove(function(){g.checkForResize()}),a(window).resize(function(){g.checkForResize()}),a(document.body).on("keydown",function(a){var b=77;a.keyCode===b&&a.ctrlKey&&a.altKey&&(null!==g.uiInstance?g.stop():g.restart())})}function c(a,c,d,e){return new b(a,c,d,e)}return b.prototype.loadUi=function(a,b){var c=this;this.stop(),this.uiname=a,this.lang=b,""===this.uiname||"none"===this.uiname||sessionStorage.getItem("disableUis")?this.uiInstance=null:require(["qtype_coderunner/ui_"+this.uiname],function(a){var b,d,e,f;e=c.wrapperNode.innerHeight()-c.GUTTER,f=c.wrapperNode.innerWidth(),d=new a.Constructor(c.taId,f,e,c.templateParams,c.lang),d.failed()?(d.destroy(),c.wrapperNode.hide(),c.uiInstance=null):(b=d.getMinSize(),c.wrapperNode.css({minWidth:b.minWidth,minHeight:b.minHeight+c.GUTTER}),c.hLast=0,c.wLast=0,c.wrapperNode.append(d.getElement()),c.textArea.hide(),c.wrapperNode.show(),c.uiInstance=d,c.checkForResize())})},b.prototype.stop=function(){null!==this.uiInstance&&(this.textArea.show(),this.uiInstance.hasFocus()&&(this.textArea.focus(),this.textArea[0].selectionStart=this.textArea[0].value.length),this.uiInstance.destroy(),this.uiInstance=null,this.wrapperNode.hide())},b.prototype.restart=function(){null===this.uiInstance&&this.loadUi(this.uiname,this.lang)},b.prototype.checkForResize=function(){var b,c,d,e,f,g,h=25;this.uiInstance&&(b=this.wrapperNode.innerHeight(),d=this.wrapperNode.innerWidth(),f=this.wrapperNode.offset().left,g=a(window).innerWidth()-f-h,c=Math.max(this.MIN_HEIGHT,b)-this.GUTTER,e=Math.max(this.MIN_WIDTH,Math.min(g,d)),(c!==this.hLast||e!==this.wLast&&this.uiInstance)&&(this.uiInstance.resize(e,c),this.hLast=c,this.wLast=e))},{newUiWrapper:c}});