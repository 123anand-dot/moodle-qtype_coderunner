define(["jquery"],function(a){function b(b,c,d,e){this.textArea=a(document.getElementById(b)),this.readOnly=this.textArea.prop("readonly"),this.templateParams=e,this.tableDiv=null,this.fail=!1,e.table_locked_cells?this.lockedCells=e.table_locked_cells:this.lockedCells=[],this.hasHeader=e.hasOwnProperty("table_num_columns"),this.hasRowLabels=e.hasOwnProperty("table_row_labels"),e.table_num_columns&&e.table_num_rows?this.reload():(this.fail=!0,this.failString="table_ui_missingparams")}return b.prototype.isLockedCell=function(a,b){for(var c=this.hasRowLabels?b-1:b,d=0;d<this.lockedCells.length;d++)if(this.lockedCells[d][0]==a&&this.lockedCells[d][1]==c)return!0;return!1},b.prototype.getElement=function(){return this.tableDiv},b.prototype.failed=function(){return this.fail},b.prototype.failMessage=function(){return this.failString},b.prototype.sync=function(){var b=[],c=!0,d=a(this.tableDiv).find("table tbody tr");d.each(function(){var d=[];a(this).find("textarea").each(function(){var b=a(this).val();d.push(b),b&&(c=!1)}),b.push(d)}),c?this.textArea.val(""):this.textArea.val(JSON.stringify(b))},b.prototype.reload=function(){var b,c,d,e=a(this.textArea).val(),f=[],g="<div style='height:fit-content' class='qtype-coderunner-table-outer-div'>\n<table class='table table-bordered qtype-coderunner_table'>\n",h=this.templateParams.table_column_width_percents,i=this.hasRowLabels?this.templateParams.table_row_labels:[],j=this.templateParams.table_num_columns+(this.hasRowLabels?1:0),k=Math.trunc(100/j);if(e)try{f=JSON.parse(e)}catch(l){return this.fail=!0,void(this.failString="table_ui_invalidjson")}try{if(g+="<thead>\n",this.hasHeader){for(g+="<tr>",d=0;d<j;d++)c=h?h[d]:k,g+="<th style='width:"+c.toString()+"%'>",b=this.hasRowLabels?0==d?"":this.templateParams.table_column_headers[d-1]:this.templateParams.table_column_headers[d],g+=b+"</th>";g+="</tr>\n"}g+="</thead>\n",g+="<tbody>\n";for(var m=Math.max(this.templateParams.table_num_rows,f.length),n=0;n<m;n++){for(g+="<tr>",d=0;d<j;d++)this.hasRowLabels&&0==d?(g+="<th style='padding:2px;text-align:center' scope='row'>",n<i.length&&(g+=i[n]),g+="</th>"):(g+="<td style='padding:2px;margin:0'>",g+='<textarea rows="2" style="width:100%;padding:0;resize:vertical;font-family: monospace"',g+=this.isLockedCell(n,d)?" disabled>":">",n<f.length&&(g+=f[n][d-(this.hasRowLabels?1:0)]),g+="</textarea>",g+="</td>");g+="</tr>"}g+="</tbody>\n</table>\n</div>",this.tableDiv=a(g),this.templateParams.table_dynamic_rows&&this.addButtons()}catch(l){this.fail=!0,this.failString="table_ui_invalidserialisation"}},b.prototype.addButtons=function(){var b='<button type="button"style="float:right;margin-right:6px" disabled>Delete row</button>',c=a(b),d=this;this.tableDiv.append(c),c.click(function(){var b=d.tableDiv.find("table tbody tr").length,c=d.tableDiv.find("tr:last");b>d.templateParams.table_num_rows&&c.remove(),c=d.tableDiv.find("tr:last"),b==d.templateParams.table_num_rows+1&&a(this).prop("disabled",!0)});var e='<button type="button"style="float:right;margin-right:6px">Add row</button>',f=a(e);d.tableDiv.append(f),f.click(function(){var b,c;b=d.tableDiv.find("table tbody tr:last"),c=b.clone(),c.find("textarea").each(function(){a(this).val("")}),b.after(c),a(this).prev().prop("disabled",!1)})},b.prototype.resize=function(){},b.prototype.hasFocus=function(){var b=!1;return a(this.tableDiv).find("textarea").each(function(){this===document.activeElement&&(b=!0)}),b},b.prototype.destroy=function(){this.sync(),a(this.tableDiv).remove(),this.tableDiv=null},{Constructor:b}});