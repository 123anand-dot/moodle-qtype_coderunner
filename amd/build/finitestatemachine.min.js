define(["jquery"],function(a){function b(a,b){this.nodeA=a,this.nodeB=b,this.text="",this.lineAngleAdjust=0,this.parallelPart=.5,this.perpendicularPart=0}function c(a,b){this.x=a,this.y=b,this.mouseOffsetX=0,this.mouseOffsetY=0,this.isAcceptState=!1,this.text=""}function d(a,b){this.node=a,this.anchorAngle=0,this.mouseOffsetAngle=0,this.text="",b&&this.setAnchorPoint(b.x,b.y)}function e(a,b){this.node=a,this.deltaX=0,this.deltaY=0,b&&this.setAnchorPoint(b.x,b.y)}function f(a,b){this.from=a,this.to=b}function g(a){for(var b=0;b<C.length;b++){var c=C[b];a=a.replace(new RegExp("\\\\"+c,"g"),String.fromCharCode(913+b+(b>16))),a=a.replace(new RegExp("\\\\"+c.toLowerCase(),"g"),String.fromCharCode(945+b+(b>16)))}for(var b=0;b<10;b++)a=a.replace(new RegExp("_"+b,"g"),String.fromCharCode(8320+b));return a}function h(a,b,c,d){var e=Math.cos(d),f=Math.sin(d);a.beginPath(),a.moveTo(b,c),a.lineTo(b-8*e+5*f,c-8*f-5*e),a.lineTo(b-8*e-5*f,c-8*f+5*e),a.fill()}function i(){return(document.activeElement||document.body)===document.body}function j(a,b,c,d,e,f){var h=g(b);a.font='20px "Times New Roman", serif';var j=a.measureText(h).width;if(c-=j/2,null!==e){var k=Math.cos(e),l=Math.sin(e),m=(j/2+5)*(k>0?1:-1),n=15*(l>0?1:-1),o=l*Math.pow(Math.abs(l),40)*m-k*Math.pow(Math.abs(k),10)*n;c+=m-l*o,d+=n+k*o}"advancedFillText"in a?a.advancedFillText(h,b,c+j/2,d,e):(c=Math.round(c),d=Math.round(d),a.fillText(h,c,d+6),f&&D&&i()&&document.hasFocus()&&(c+=j,a.beginPath(),a.moveTo(c,d-10),a.lineTo(c,d+10),a.stroke()))}function k(){clearInterval(z),z=setInterval(function(){D=!D,n()},500),D=!0}function l(a){a.beginPath(),a.fillStyle="rgba(119,136,153,0.5)",a.fillRect(750,0,50,25),a.lineWidth=2,a.strokeStyle="#000000",a.stroke(),a.closePath(),a.font='12pt "Times New Roman", serif',a.fillStyle="#000000",a.textAlign="center",a.fillText("Help",775,17),a.textAlign="left"}function m(a){a.clearRect(0,0,A.width,A.height),a.save(),a.translate(.5,.5),l(a);for(var b=0;b<F.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=F[b]===J?"blue":"black",F[b].draw(a);for(var b=0;b<G.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=G[b]===J?"blue":"black",G[b].draw(a);null!==K&&(a.lineWidth=1,a.fillStyle=a.strokeStyle="black",K.draw(a)),a.restore()}function n(){m(A.getContext("2d")),x()}function o(a,b){for(var c=0;c<F.length;c++)if(F[c].containsPoint(a,b))return F[c];for(var c=0;c<G.length;c++)if(G[c].containsPoint(a,b))return G[c];return null}function p(a){for(var b=0;b<F.length;b++)F[b]!==a&&(Math.abs(a.x-F[b].x)<H&&(a.x=F[b].x),Math.abs(a.y-F[b].y)<H&&(a.y=F[b].y))}function q(a){return a=a||window.event,a.which||a.keyCode}function r(a){a=a||window.event;for(var b=a.target||a.srcElement,c=0,d=0;b.offsetParent;)c+=b.offsetLeft,d+=b.offsetTop,b=b.offsetParent;return{x:c,y:d}}function s(a){return a=a||window.event,{x:a.pageX||a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:a.pageY||a.clientY+document.body.scrollTop+document.documentElement.scrollTop}}function t(a){var b=r(a),c=s(a);return{x:c.x-b.x,y:c.y-b.y}}function u(a,b,c,d,e,f,g,h,i){return a*e*i+b*f*g+c*d*h-a*f*h-b*d*i-c*e*g}function v(a,b,c,d,e,f){var g=u(a,b,1,c,d,1,e,f,1),h=-u(a*a+b*b,b,1,c*c+d*d,d,1,e*e+f*f,f,1),i=u(a*a+b*b,a,1,c*c+d*d,c,1,e*e+f*f,e,1),j=-u(a*a+b*b,a,b,c*c+d*d,c,d,e*e+f*f,e,f);return{x:-h/(2*g),y:-i/(2*g),radius:Math.sqrt(h*h+i*i-4*g*j)/(2*Math.abs(g))}}function w(){if(JSON)try{for(var a=JSON.parse(y.val()),f=0;f<a.nodes.length;f++){var g=a.nodes[f],h=a.nodeGeometry[f],i=new c(h[0],h[1]);i.isAcceptState=g[1],i.text=g[0],F.push(i)}for(var f=0;f<a.edges.length;f++){var j=a.edges[f],k=a.edgeGeometry[f],l=null;j[0]===j[1]?(l=new d(F[j[0]]),l.anchorAngle=k.anchorAngle,l.text=j[2]):j[0]===-1?(l=new e(F[j[1]]),l.deltaX=k.deltaX,l.deltaY=k.deltaY):(l=new b(F[j[0]],F[j[1]]),l.parallelPart=k.parallelPart,l.perpendicularPart=k.perpendicularPart,l.text=j[2],l.lineAngleAdjust=k.lineAngleAdjust),null!==l&&G.push(l)}}catch(m){}}function x(){if(JSON){for(var a={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},c=0;c<F.length;c++){var f=F[c],g=[f.text,f.isAcceptState],h=[f.x,f.y];a.nodeGeometry.push(h),a.nodes.push(g)}for(var c=0;c<G.length;c++){var i=G[c],j=null,k=null;i instanceof d?(k={anchorAngle:i.anchorAngle},j=[F.indexOf(i.node),F.indexOf(i.node),i.text]):i instanceof e?(k={deltaX:i.deltaX,deltaY:i.deltaY},j=[-1,F.indexOf(i.node),""]):i instanceof b&&(k={lineAngleAdjust:i.lineAngleAdjust,parallelPart:i.parallelPart,perpendicularPart:i.perpendicularPart},j=[F.indexOf(i.nodeA),F.indexOf(i.nodeB),i.text]),null!==j&&null!==k&&(a.edges.push(j),a.edgeGeometry.push(k))}y.val(JSON.stringify(a))}}var y;b.prototype.getAnchorPoint=function(){var a=this.nodeB.x-this.nodeA.x,b=this.nodeB.y-this.nodeA.y,c=Math.sqrt(a*a+b*b);return{x:this.nodeA.x+a*this.parallelPart-b*this.perpendicularPart/c,y:this.nodeA.y+b*this.parallelPart+a*this.perpendicularPart/c}},b.prototype.setAnchorPoint=function(a,b){var c=this.nodeB.x-this.nodeA.x,d=this.nodeB.y-this.nodeA.y,e=Math.sqrt(c*c+d*d);this.parallelPart=(c*(a-this.nodeA.x)+d*(b-this.nodeA.y))/(e*e),this.perpendicularPart=(c*(b-this.nodeA.y)-d*(a-this.nodeA.x))/e,this.parallelPart>0&&this.parallelPart<1&&Math.abs(this.perpendicularPart)<H&&(this.lineAngleAdjust=(this.perpendicularPart<0)*Math.PI,this.perpendicularPart=0)},b.prototype.getEndPointsAndCircle=function(){if(0===this.perpendicularPart){var a=(this.nodeA.x+this.nodeB.x)/2,b=(this.nodeA.y+this.nodeB.y)/2,c=this.nodeA.closestPointOnCircle(a,b),d=this.nodeB.closestPointOnCircle(a,b);return{hasCircle:!1,startX:c.x,startY:c.y,endX:d.x,endY:d.y}}var e=this.getAnchorPoint(),f=v(this.nodeA.x,this.nodeA.y,this.nodeB.x,this.nodeB.y,e.x,e.y),g=this.perpendicularPart>0,h=g?1:-1,i=Math.atan2(this.nodeA.y-f.y,this.nodeA.x-f.x)-h*E/f.radius,j=Math.atan2(this.nodeB.y-f.y,this.nodeB.x-f.x)+h*E/f.radius,k=f.x+f.radius*Math.cos(i),l=f.y+f.radius*Math.sin(i),m=f.x+f.radius*Math.cos(j),n=f.y+f.radius*Math.sin(j);return{hasCircle:!0,startX:k,startY:l,endX:m,endY:n,startAngle:i,endAngle:j,circleX:f.x,circleY:f.y,circleRadius:f.radius,reverseScale:h,isReversed:g}},b.prototype.draw=function(a){var b=this.getEndPointsAndCircle();if(a.beginPath(),b.hasCircle?a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,b.isReversed):(a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY)),a.stroke(),b.hasCircle?h(a,b.endX,b.endY,b.endAngle-b.reverseScale*(Math.PI/2)):h(a,b.endX,b.endY,Math.atan2(b.endY-b.startY,b.endX-b.startX)),b.hasCircle){var c=b.startAngle,d=b.endAngle;d<c&&(d+=2*Math.PI);var e=(c+d)/2+b.isReversed*Math.PI,f=b.circleX+b.circleRadius*Math.cos(e),g=b.circleY+b.circleRadius*Math.sin(e);j(a,this.text,f,g,e,J===this)}else{var f=(b.startX+b.endX)/2,g=(b.startY+b.endY)/2,e=Math.atan2(b.endX-b.startX,b.startY-b.endY);j(a,this.text,f,g,e+this.lineAngleAdjust,J===this)}},b.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle();if(!c.hasCircle){var d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<I}var d=a-c.circleX,e=b-c.circleY,h=Math.sqrt(d*d+e*e)-c.circleRadius;if(Math.abs(h)<I){var i=Math.atan2(e,d),j=c.startAngle,k=c.endAngle;if(c.isReversed){var l=j;j=k,k=l}return k<j&&(k+=2*Math.PI),i<j?i+=2*Math.PI:i>k&&(i-=2*Math.PI),i>j&&i<k}return!1},c.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.x-a,this.mouseOffsetY=this.y-b},c.prototype.setAnchorPoint=function(a,b){this.x=a+this.mouseOffsetX,this.y=b+this.mouseOffsetY},c.prototype.draw=function(a){a.beginPath(),a.arc(this.x,this.y,E,0,2*Math.PI,!1),a.stroke(),j(a,this.text,this.x,this.y,null,J===this),this.isAcceptState&&(a.beginPath(),a.arc(this.x,this.y,E-6,0,2*Math.PI,!1),a.stroke())},c.prototype.closestPointOnCircle=function(a,b){var c=a-this.x,d=b-this.y,e=Math.sqrt(c*c+d*d);return{x:this.x+c*E/e,y:this.y+d*E/e}},c.prototype.containsPoint=function(a,b){return(a-this.x)*(a-this.x)+(b-this.y)*(b-this.y)<E*E},d.prototype.setMouseStart=function(a,b){this.mouseOffsetAngle=this.anchorAngle-Math.atan2(b-this.node.y,a-this.node.x)},d.prototype.setAnchorPoint=function(a,b){this.anchorAngle=Math.atan2(b-this.node.y,a-this.node.x)+this.mouseOffsetAngle;var c=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);Math.abs(this.anchorAngle-c)<.1&&(this.anchorAngle=c),this.anchorAngle<-Math.PI&&(this.anchorAngle+=2*Math.PI),this.anchorAngle>Math.PI&&(this.anchorAngle-=2*Math.PI)},d.prototype.getEndPointsAndCircle=function(){var a=this.node.x+1.5*E*Math.cos(this.anchorAngle),b=this.node.y+1.5*E*Math.sin(this.anchorAngle),c=.75*E,d=this.anchorAngle-.8*Math.PI,e=this.anchorAngle+.8*Math.PI,f=a+c*Math.cos(d),g=b+c*Math.sin(d),h=a+c*Math.cos(e),i=b+c*Math.sin(e);return{hasCircle:!0,startX:f,startY:g,endX:h,endY:i,startAngle:d,endAngle:e,circleX:a,circleY:b,circleRadius:c}},d.prototype.draw=function(a){var b=this.getEndPointsAndCircle();a.beginPath(),a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,!1),a.stroke();var c=b.circleX+b.circleRadius*Math.cos(this.anchorAngle),d=b.circleY+b.circleRadius*Math.sin(this.anchorAngle);j(a,this.text,c,d,this.anchorAngle,J===this),h(a,b.endX,b.endY,b.endAngle+.4*Math.PI)},d.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d=a-c.circleX,e=b-c.circleY,f=Math.sqrt(d*d+e*e)-c.circleRadius;return Math.abs(f)<I},e.prototype.setAnchorPoint=function(a,b){this.deltaX=a-this.node.x,this.deltaY=b-this.node.y,Math.abs(this.deltaX)<H&&(this.deltaX=0),Math.abs(this.deltaY)<H&&(this.deltaY=0)},e.prototype.getEndPoints=function(){var a=this.node.x+this.deltaX,b=this.node.y+this.deltaY,c=this.node.closestPointOnCircle(a,b);return{startX:a,startY:b,endX:c.x,endY:c.y}},e.prototype.draw=function(a){var b=this.getEndPoints();a.beginPath(),a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY),a.stroke(),h(a,b.endX,b.endY,Math.atan2(-this.deltaY,-this.deltaX))},e.prototype.containsPoint=function(a,b){var c=this.getEndPoints(),d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<I},f.prototype.draw=function(a){a.beginPath(),a.moveTo(this.to.x,this.to.y),a.lineTo(this.from.x,this.from.y),a.stroke(),h(a,this.to.x,this.to.y,Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x))};var z,A,B,C=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"],D=!0,E=30,F=[],G=[],H=6,I=6,J=null,K=null,L=!1,N=!1;document.onkeydown=function(a){var b=q(a);if(16===b)N=!0;else{if(!i())return!0;if(8===b)return null!==J&&"text"in J&&(J.text=J.text.substr(0,J.text.length-1),k(),n()),!1;if(46===b){if(null!==J){for(var c=0;c<F.length;c++)F[c]===J&&F.splice(c--,1);for(var c=0;c<G.length;c++)G[c]!==J&&G[c].node!==J&&G[c].nodeA!==J&&G[c].nodeB!==J||G.splice(c--,1);J=null,n()}}else 13===b&&null!==J&&(J=null,n())}},document.onkeyup=function(a){var b=q(a);16===b&&(N=!1)},document.onkeypress=function(a){var b=q(a);return!i()||(b>=32&&b<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==J&&"text"in J?(J.text+=String.fromCharCode(b),k(),n(),!1):8!==b&&void 0)};var O=function(){a(document.body).on("keydown",function(b){var c=77;b.keyCode===c&&b.ctrlKey&&b.altKey&&(a(A).toggle(),a(y).toggle())})},P=function(a,b){return a.x>b.x&&a.x<b.x+b.width&&a.y<b.y+b.height&&a.y>b.y};return O.prototype.stop=function(){A=document.getElementById("canvas"),A.parentNode.removeChild(A)},O.prototype.init=function(g){y=a(document.getElementById(g)),A=document.createElement("canvas"),A.setAttribute("id","canvas"),A.setAttribute("width","800"),A.setAttribute("height","600"),A.setAttribute("style","background-color: white"),a(A).insertBefore(y),a(y).hide(),w(),n();var h={x:750,y:0,width:50,height:25};A.onmousedown=function(a){var b=t(a);if(J=o(b.x,b.y),L=!1,B=b,P(b,h)){var e=M.util.get_string("fsmhelp","qtype_coderunner");alert(e)}return null!==J?(N&&J instanceof c?K=new d(J,b):(L=!0,J.setMouseStart&&J.setMouseStart(b.x,b.y)),k()):N&&(K=new f(b,b)),n(),!i()&&(k(),!0)},A.ondblclick=function(a){var b=t(a);J=o(b.x,b.y),null===J?(J=new c(b.x,b.y),F.push(J),k(),n()):J instanceof c&&(J.isAcceptState=!J.isAcceptState,n())},A.onmousemove=function(a){var g=t(a);if(null!==K){var h=o(g.x,g.y);h instanceof c||(h=null),K=null===J?null!==h?new e(h,B):new f(B,g):h===J?new d(J,g):null!==h?new b(J,h):new f(J.closestPointOnCircle(g.x,g.y),g),n()}L&&(J.setAnchorPoint(g.x,g.y),J instanceof c&&p(J),n())},A.onmouseup=function(){L=!1,null!==K&&(K instanceof f||(J=K,G.push(K),k()),K=null,n())}},new O});