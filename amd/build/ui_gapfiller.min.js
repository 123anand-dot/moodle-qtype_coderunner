define(["jquery"],function(a){function b(b,c,d,e){this.textArea=a(document.getElementById(b)),this.html=this.textArea.attr("data-globalextra").replace("<","&lt;"),this.readOnly=this.textArea.prop("readonly"),this.templateParams=e,this.fail=!1,this.htmlDiv=null,this.prefix="crui_",this.reload()}return b.prototype.failed=function(){return this.fail},b.prototype.sync=function(){var b,c={},d=this,e=!0;this.getFields().each(function(){var f,g;g=a(this).attr("type"),b=a(this).attr("name"),b.startsWith(d.prefix)&&(b=b.substring(d.prefix.length,b.length)),f="checkbox"!==g&&"radio"!==g||a(this).is(":checked")?a(this).val():"",c.hasOwnProperty(b)?c[b].push(f):c[b]=[f],""!==f&&(e=!1)}),e?this.textArea.val(""):this.textArea.val(JSON.stringify(c))},b.prototype.getElement=function(){return this.htmlDiv},b.prototype.getFields=function(){return a(this.htmlDiv).find(".coderunner-ui-element")},b.prototype.setField=function(a,b){"checkbox"===a.attr("type")||"radio"===a.attr("type")?a.prop("checked",a.val()===b):a.val(b)},b.prototype.markedUpHtml=function(){function a(a){for(var b,c="{[(*+\\",d="",e=0;e<a.length;e++){b=a[e];for(var f=0;f<c.length;f++)b===c[f]&&(b="\\"+b);d+=b}return d}var b,c=a("{["),d=a("]}"),e=new RegExp(c+"(.+?)"+d),f=this.html.split(e),g="<pre>"+f[0];for(b=1;b<f.length;b+=2)g+=this.markUp(f[b]),b+1<f.length&&(g+=f[b+1]);return g+"</pre>"},b.prototype.markUp=function(a){function b(a,b){return a=a||"value",b=b||10,'<input name="'+g.prefix+a+'" class="coderunner-ui-element" size="'+b+'">'}function c(a,b,c){return a=a||"value",c=c||60,b=b||2,'<textarea name="'+g.prefix+a+'" class ="coderunner-ui-element" rows="'+b+'" cols="'+c+'" style="width:auto;" />'}var d,e,f="",g=this;return a=a.trim(),d=/(\w+)?\((?:(['"])(\w*)\2)?(?:, *(\d+))?(?:, (\d+))?\)/,e=a.match(d),e&&"input"===e[1]?f=b(e[3],e[4]):e&&"textarea"===e[1]&&(f=c(e[3],e[4],e[5])),f},b.prototype.reload=function(){var b,c,d,e,f,g,h=a(this.textArea).val(),i="<div style='height:fit-content' class='qtype-coderunner-html-outer-div'>";if(this.htmlDiv=a(i+this.markedUpHtml()+"</div>"),this.htmlDiv.data("templateparams",this.templateParams),h)try{b=JSON.parse(h),g={};for(var j in b){for(e=this.prefix+j,c=b[j],f=this.getFields().filter("[name='"+e+"']"),g[j]=[],d=0;d<c.length;d++)d<f.length?this.setField(a(f[d]),c[d]):g[j].push(c[d]);0===g[j].length&&delete g[j]}a.isEmptyObject(g)||this.htmlDiv.data("leftovers",g)}catch(k){alert("Failed to initialise GapFiller UI"),this.fail=!0}},b.prototype.resize=function(){},b.prototype.hasFocus=function(){var a=!1;return this.getFields().each(function(){this===document.activeElement&&(a=!0)}),a},b.prototype.destroy=function(){this.sync(),a(this.htmlDiv).remove(),this.htmlDiv=null},{Constructor:b}});