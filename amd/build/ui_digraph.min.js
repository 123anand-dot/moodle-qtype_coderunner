define(["jquery"],function(a){function b(a){for(var b=0;b<w.length;b++){var c=w[b];a=a.replace(new RegExp("\\\\"+c,"g"),String.fromCharCode(913+b+(b>16))),a=a.replace(new RegExp("\\\\"+c.toLowerCase(),"g"),String.fromCharCode(945+b+(b>16)))}for(var b=0;b<10;b++)a=a.replace(new RegExp("_"+b,"g"),String.fromCharCode(8320+b));return a}function c(a,b,c,d){var e=Math.cos(d),f=Math.sin(d);a.beginPath(),a.moveTo(b,c),a.lineTo(b-8*e+5*f,c-8*f-5*e),a.lineTo(b-8*e-5*f,c-8*f+5*e),a.fill()}function d(a,b,c,d,e,f,g,h,i){return a*e*i+b*f*g+c*d*h-a*f*h-b*d*i-c*e*g}function e(a,b,c,e,f,g){var h=d(a,b,1,c,e,1,f,g,1),i=-d(a*a+b*b,b,1,c*c+e*e,e,1,f*f+g*g,g,1),j=d(a*a+b*b,a,1,c*c+e*e,c,1,f*f+g*g,f,1),k=-d(a*a+b*b,a,b,c*c+e*e,c,e,f*f+g*g,f,g);return{x:-i/(2*h),y:-j/(2*h),radius:Math.sqrt(i*i+j*j-4*h*k)/(2*Math.abs(h))}}function f(a,b){return a.x>b.x&&a.x<b.x+b.width&&a.y<b.y+b.height&&a.y>b.y}function g(a){return a=a||window.event,a.which||a.keyCode}function h(a){a=a||window.event;for(var b=a.target||a.srcElement,c=0,d=0;b.offsetParent;)c+=b.offsetLeft,d+=b.offsetTop,b=b.offsetParent;return{x:c,y:d}}function i(a){return a=a||window.event,{x:a.pageX||a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:a.pageY||a.clientY+document.body.scrollTop+document.documentElement.scrollTop}}function j(a){var b=h(a),c=i(a);return{x:c.x-b.x,y:c.y-b.y}}function k(a){a.beginPath(),a.fillStyle="rgba(119,136,153,0.5)",a.fillRect(750,0,50,25),a.lineWidth=2,a.strokeStyle="#000000",a.stroke(),a.closePath(),a.font='12pt "Times New Roman", serif',a.fillStyle="#000000",a.textAlign="center",a.fillText("Help",775,17),a.textAlign="left"}function l(a,b,c){this.parent=a,this.x=b,this.y=c,this.mouseOffsetX=0,this.mouseOffsetY=0,this.isAcceptState=!1,this.text=""}function m(a,b,c){this.parent=a,this.nodeA=b,this.nodeB=c,this.text="",this.lineAngleAdjust=0,this.parallelPart=.5,this.perpendicularPart=0}function n(a,b,c){this.parent=a,this.node=b,this.anchorAngle=0,this.mouseOffsetAngle=0,this.text="",c&&this.setAnchorPoint(c.x,c.y)}function o(a,b,c){this.parent=a,this.node=b,this.deltaX=0,this.deltaY=0,c&&this.setAnchorPoint(c.x,c.y)}function p(a,b,c){this.parent=a,this.from=b,this.to=c}function q(a,b){this.parent=a,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","id_fsmcanvas_"+b),this.canvas.setAttribute("width","800"),this.canvas.setAttribute("height","600"),this.canvas.setAttribute("style","background-color: white"),this.canvas.setAttribute("class","coderunner_fsmcanvas"),this.canvas.setAttribute("tabindex","1"),this.canvas.onmousedown=function(b){a.mousedown(b)},this.canvas.onmouseup=function(b){a.mouseup(b)},this.canvas.ondblclick=function(b){a.dblclick(b)},this.canvas.onkeydown=function(b){a.keydown(b)},this.canvas.onmousemove=function(b){a.mousemove(b)},this.canvas.onkeypress=function(b){a.keypress(b)}}function r(b){this.helpBox={x:750,y:0,width:50,height:25},this.graphCanvas=new q(this,b),this.textArea=document.getElementById(b),this.caretVisible=!0,this.caretTimer=0,this.originalClick=null,this.nodes=[],this.links=[],this.selectedObject=null,this.currentLink=null,this.movingObject=!1,a(this.getCanvas()).insertBefore(this.textArea),a(this.textArea).hide(),this.restoreBackup(),this.draw()}function s(){var b=this;this.activeInstances=[],a(document.body).on("keydown",function(c){var d,e,f=77;if(c.keyCode===f&&c.ctrlKey&&c.altKey)for(var g in b.activeInstances)d=b.activeInstances[g],e=document.getElementById(g),a(d.getCanvas()).toggle(),a(e).toggle()})}var t=6,u=6,v=20,w=["Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"];return l.prototype.setMouseStart=function(a,b){this.mouseOffsetX=this.x-a,this.mouseOffsetY=this.y-b},l.prototype.setAnchorPoint=function(a,b){this.x=a+this.mouseOffsetX,this.y=b+this.mouseOffsetY},l.prototype.draw=function(a){a.beginPath(),a.arc(this.x,this.y,v,0,2*Math.PI,!1),a.stroke(),this.parent.drawText(this.text,this.x,this.y,null,this),this.isAcceptState&&(a.beginPath(),a.arc(this.x,this.y,v-6,0,2*Math.PI,!1),a.stroke())},l.prototype.closestPointOnCircle=function(a,b){var c=a-this.x,d=b-this.y,e=Math.sqrt(c*c+d*d);return{x:this.x+c*v/e,y:this.y+d*v/e}},l.prototype.containsPoint=function(a,b){return(a-this.x)*(a-this.x)+(b-this.y)*(b-this.y)<v*v},m.prototype.getAnchorPoint=function(){var a=this.nodeB.x-this.nodeA.x,b=this.nodeB.y-this.nodeA.y,c=Math.sqrt(a*a+b*b);return{x:this.nodeA.x+a*this.parallelPart-b*this.perpendicularPart/c,y:this.nodeA.y+b*this.parallelPart+a*this.perpendicularPart/c}},m.prototype.setAnchorPoint=function(a,b){var c=this.nodeB.x-this.nodeA.x,d=this.nodeB.y-this.nodeA.y,e=Math.sqrt(c*c+d*d);this.parallelPart=(c*(a-this.nodeA.x)+d*(b-this.nodeA.y))/(e*e),this.perpendicularPart=(c*(b-this.nodeA.y)-d*(a-this.nodeA.x))/e,this.parallelPart>0&&this.parallelPart<1&&Math.abs(this.perpendicularPart)<t&&(this.lineAngleAdjust=(this.perpendicularPart<0)*Math.PI,this.perpendicularPart=0)},m.prototype.getEndPointsAndCircle=function(){if(0===this.perpendicularPart){var a=(this.nodeA.x+this.nodeB.x)/2,b=(this.nodeA.y+this.nodeB.y)/2,c=this.nodeA.closestPointOnCircle(a,b),d=this.nodeB.closestPointOnCircle(a,b);return{hasCircle:!1,startX:c.x,startY:c.y,endX:d.x,endY:d.y}}var f=this.getAnchorPoint(),g=e(this.nodeA.x,this.nodeA.y,this.nodeB.x,this.nodeB.y,f.x,f.y),h=this.perpendicularPart>0,i=h?1:-1,j=i*v/g.radius,k=Math.atan2(this.nodeA.y-g.y,this.nodeA.x-g.x)-j,l=Math.atan2(this.nodeB.y-g.y,this.nodeB.x-g.x)+j,m=g.x+g.radius*Math.cos(k),n=g.y+g.radius*Math.sin(k),o=g.x+g.radius*Math.cos(l),p=g.y+g.radius*Math.sin(l);return{hasCircle:!0,startX:m,startY:n,endX:o,endY:p,startAngle:k,endAngle:l,circleX:g.x,circleY:g.y,circleRadius:g.radius,reverseScale:i,isReversed:h}},m.prototype.draw=function(a){var b=this.getEndPointsAndCircle();if(a.beginPath(),b.hasCircle?a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,b.isReversed):(a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY)),a.stroke(),b.hasCircle?c(a,b.endX,b.endY,b.endAngle-b.reverseScale*(Math.PI/2)):c(a,b.endX,b.endY,Math.atan2(b.endY-b.startY,b.endX-b.startX)),b.hasCircle){var d=b.startAngle,e=b.endAngle;e<d&&(e+=2*Math.PI);var f=(d+e)/2+b.isReversed*Math.PI,g=b.circleX+b.circleRadius*Math.cos(f),h=b.circleY+b.circleRadius*Math.sin(f);this.parent.drawText(this.text,g,h,f,this)}else{var g=(b.startX+b.endX)/2,h=(b.startY+b.endY)/2,f=Math.atan2(b.endX-b.startX,b.startY-b.endY);this.parent.drawText(this.text,g,h,f+this.lineAngleAdjust,this)}},m.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle();if(!c.hasCircle){var d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<u}var d=a-c.circleX,e=b-c.circleY,h=Math.sqrt(d*d+e*e)-c.circleRadius;if(Math.abs(h)<u){var i=Math.atan2(e,d),j=c.startAngle,k=c.endAngle;if(c.isReversed){var l=j;j=k,k=l}return k<j&&(k+=2*Math.PI),i<j?i+=2*Math.PI:i>k&&(i-=2*Math.PI),i>j&&i<k}return!1},n.prototype.setMouseStart=function(a,b){this.mouseOffsetAngle=this.anchorAngle-Math.atan2(b-this.node.y,a-this.node.x)},n.prototype.setAnchorPoint=function(a,b){this.anchorAngle=Math.atan2(b-this.node.y,a-this.node.x)+this.mouseOffsetAngle;var c=Math.round(this.anchorAngle/(Math.PI/2))*(Math.PI/2);Math.abs(this.anchorAngle-c)<.1&&(this.anchorAngle=c),this.anchorAngle<-Math.PI&&(this.anchorAngle+=2*Math.PI),this.anchorAngle>Math.PI&&(this.anchorAngle-=2*Math.PI)},n.prototype.getEndPointsAndCircle=function(){var a=this.node.x+1.5*v*Math.cos(this.anchorAngle),b=this.node.y+1.5*v*Math.sin(this.anchorAngle),c=.75*v,d=this.anchorAngle-.8*Math.PI,e=this.anchorAngle+.8*Math.PI,f=a+c*Math.cos(d),g=b+c*Math.sin(d),h=a+c*Math.cos(e),i=b+c*Math.sin(e);return{hasCircle:!0,startX:f,startY:g,endX:h,endY:i,startAngle:d,endAngle:e,circleX:a,circleY:b,circleRadius:c}},n.prototype.draw=function(a){var b=this.getEndPointsAndCircle();a.beginPath(),a.arc(b.circleX,b.circleY,b.circleRadius,b.startAngle,b.endAngle,!1),a.stroke();var d=b.circleX+b.circleRadius*Math.cos(this.anchorAngle),e=b.circleY+b.circleRadius*Math.sin(this.anchorAngle);this.parent.drawText(this.text,d,e,this.anchorAngle,this),c(a,b.endX,b.endY,b.endAngle+.4*Math.PI)},n.prototype.containsPoint=function(a,b){var c=this.getEndPointsAndCircle(),d=a-c.circleX,e=b-c.circleY,f=Math.sqrt(d*d+e*e)-c.circleRadius;return Math.abs(f)<u},o.prototype.setAnchorPoint=function(a,b){this.deltaX=a-this.node.x,this.deltaY=b-this.node.y,Math.abs(this.deltaX)<t&&(this.deltaX=0),Math.abs(this.deltaY)<t&&(this.deltaY=0)},o.prototype.getEndPoints=function(){var a=this.node.x+this.deltaX,b=this.node.y+this.deltaY,c=this.node.closestPointOnCircle(a,b);return{startX:a,startY:b,endX:c.x,endY:c.y}},o.prototype.draw=function(a){var b=this.getEndPoints();a.beginPath(),a.moveTo(b.startX,b.startY),a.lineTo(b.endX,b.endY),a.stroke(),c(a,b.endX,b.endY,Math.atan2(-this.deltaY,-this.deltaX))},o.prototype.containsPoint=function(a,b){var c=this.getEndPoints(),d=c.endX-c.startX,e=c.endY-c.startY,f=Math.sqrt(d*d+e*e),g=(d*(a-c.startX)+e*(b-c.startY))/(f*f),h=(d*(b-c.startY)-e*(a-c.startX))/f;return g>0&&g<1&&Math.abs(h)<u},p.prototype.draw=function(a){a.beginPath(),a.moveTo(this.to.x,this.to.y),a.lineTo(this.from.x,this.from.y),a.stroke(),c(a,this.to.x,this.to.y,Math.atan2(this.to.y-this.from.y,this.to.x-this.from.x))},r.prototype.getCanvas=function(){return this.graphCanvas.canvas},r.prototype.keypress=function(a){var b=g(a);return b>=32&&b<=126&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&"text"in this.selectedObject?(this.selectedObject.text+=String.fromCharCode(b),this.resetCaret(),this.draw(),!1):8!==b&&void 0},r.prototype.mousedown=function(a){var b=j(a);if(this.selectedObject=this.selectObject(b.x,b.y),this.movingObject=!1,this.originalClick=b,f(b,this.helpBox)){var c=M.util.get_string("fsmhelp","qtype_coderunner");alert(c)}return null!==this.selectedObject?(a.shiftKey&&this.selectedObject instanceof l?this.currentLink=new n(this,this.selectedObject,b):(this.movingObject=!0,this.selectedObject.setMouseStart&&this.selectedObject.setMouseStart(b.x,b.y)),this.resetCaret()):a.shiftKey&&(this.currentLink=new p(this,b,b)),this.draw(),!this.canvasHasFocus()&&(this.resetCaret(),!0)},r.prototype.keydown=function(a){var b=g(a);if(8===b)return null!==this.selectedObject&&"text"in this.selectedObject&&(this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1),this.resetCaret(),this.draw()),!1;if(46===b){if(null!==this.selectedObject){for(var c=0;c<this.nodes.length;c++)this.nodes[c]===this.selectedObject&&this.nodes.splice(c--,1);for(var c=0;c<this.links.length;c++)this.links[c]!==this.selectedObject&&this.links[c].node!==this.selectedObject&&this.links[c].nodeA!==this.selectedObject&&this.links[c].nodeB!==this.selectedObject||this.links.splice(c--,1);this.selectedObject=null,this.draw()}}else 13===b&&null!==this.selectedObject&&(this.selectedObject=null,this.draw())},r.prototype.dblclick=function(a){var b=j(a);this.selectedObject=this.selectObject(b.x,b.y),null===this.selectedObject?(this.selectedObject=new l(this,b.x,b.y),this.nodes.push(this.selectedObject),this.resetCaret(),this.draw()):this.selectedObject instanceof l&&(this.selectedObject.isAcceptState=!this.selectedObject.isAcceptState,this.draw())},r.prototype.mousemove=function(a){var b=j(a);if(null!==this.currentLink){var c=this.selectObject(b.x,b.y);c instanceof l||(c=null),null===this.selectedObject?null!==c?this.currentLink=new o(this,c,this.originalClick):this.currentLink=new p(this,this.originalClick,b):c===this.selectedObject?this.currentLink=new n(this,this.selectedObject,b):null!==c?this.currentLink=new m(this,this.selectedObject,c):this.currentLink=new p(this,this.selectedObject.closestPointOnCircle(b.x,b.y),b),this.draw()}this.movingObject&&(this.selectedObject.setAnchorPoint(b.x,b.y),this.selectedObject instanceof l&&this.snapNode(this.selectedObject),this.draw())},r.prototype.mouseup=function(){this.movingObject=!1,null!==this.currentLink&&(this.currentLink instanceof p||(this.selectedObject=this.currentLink,this.links.push(this.currentLink),this.resetCaret()),this.currentLink=null,this.draw())},r.prototype.selectObject=function(a,b){for(var c=0;c<this.nodes.length;c++)if(this.nodes[c].containsPoint(a,b))return this.nodes[c];for(var c=0;c<this.links.length;c++)if(this.links[c].containsPoint(a,b))return this.links[c];return null},r.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b]!==a&&(Math.abs(a.x-this.nodes[b].x)<t&&(a.x=this.nodes[b].x),Math.abs(a.y-this.nodes[b].y)<t&&(a.y=this.nodes[b].y))},r.prototype.restoreBackup=function(){if(JSON)try{for(var b=JSON.parse(a(this.textArea).val()),c=0;c<b.nodes.length;c++){var d=b.nodes[c],e=b.nodeGeometry[c],f=new l(this,e[0],e[1]);f.isAcceptState=d[1],f.text=d[0],this.nodes.push(f)}for(var c=0;c<b.edges.length;c++){var g=b.edges[c],h=b.edgeGeometry[c],i=null;g[0]===g[1]?(i=new n(this,this.nodes[g[0]]),i.anchorAngle=h.anchorAngle,i.text=g[2]):g[0]===-1?(i=new o(this,this.nodes[g[1]]),i.deltaX=h.deltaX,i.deltaY=h.deltaY):(i=new m(this,this.nodes[g[0]],this.nodes[g[1]]),i.parallelPart=h.parallelPart,i.perpendicularPart=h.perpendicularPart,i.text=g[2],i.lineAngleAdjust=h.lineAngleAdjust),null!==i&&this.links.push(i)}}catch(j){}},r.prototype.saveBackup=function(){if(JSON){for(var b={edgeGeometry:[],nodeGeometry:[],nodes:[],edges:[]},c=0;c<this.nodes.length;c++){var d=this.nodes[c],e=[d.text,d.isAcceptState],f=[d.x,d.y];b.nodeGeometry.push(f),b.nodes.push(e)}for(var c=0;c<this.links.length;c++){var g=this.links[c],h=null,i=null;g instanceof n?(i={anchorAngle:g.anchorAngle},h=[this.nodes.indexOf(g.node),this.nodes.indexOf(g.node),g.text]):g instanceof o?(i={deltaX:g.deltaX,deltaY:g.deltaY},h=[-1,this.nodes.indexOf(g.node),""]):g instanceof m&&(i={lineAngleAdjust:g.lineAngleAdjust,parallelPart:g.parallelPart,perpendicularPart:g.perpendicularPart},h=[this.nodes.indexOf(g.nodeA),this.nodes.indexOf(g.nodeB),g.text]),null!==h&&null!==i&&(b.edges.push(h),b.edgeGeometry.push(i))}a(this.textArea).val(JSON.stringify(b))}},r.prototype.destroy=function(){var a=this.getCanvas();a.parentNode.removeChild(a)},r.prototype.canvasHasFocus=function(){return document.activeElement==this.getCanvas()},r.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer),this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible,a.draw()},500),this.caretVisible=!0},r.prototype.draw=function(){var a=this.getCanvas().getContext("2d");a.clearRect(0,0,this.getCanvas().width,this.getCanvas().height),a.save(),a.translate(.5,.5),k(a);for(var b=0;b<this.nodes.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=this.nodes[b]===this.selectedObject?"blue":"black",this.nodes[b].draw(a);for(var b=0;b<this.links.length;b++)a.lineWidth=1,a.fillStyle=a.strokeStyle=this.links[b]===this.selectedObject?"blue":"black",this.links[b].draw(a);null!==this.currentLink&&(a.lineWidth=1,a.fillStyle=a.strokeStyle="black",this.currentLink.draw(a)),a.restore(),this.saveBackup()},r.prototype.drawText=function(a,c,d,e,f){var g=this.getCanvas().getContext("2d"),h=b(a),i=g.measureText(h).width;if(g.font='20px "Times New Roman", serif',c-=i/2,null!==e){var j=Math.cos(e),k=Math.sin(e),l=(i/2+5)*(j>0?1:-1),m=15*(k>0?1:-1),n=k*Math.pow(Math.abs(k),40)*l-j*Math.pow(Math.abs(j),10)*m;c+=l-k*n,d+=m+j*n}"advancedFillText"in g?g.advancedFillText(h,a,c+i/2,d,e):(c=Math.round(c),d=Math.round(d),g.fillText(h,c,d+6),f==this.selectedObject&&this.caretVisible&&this.canvasHasFocus()&&document.hasFocus()&&(c+=i,g.beginPath(),g.moveTo(c,d-10),g.lineTo(c,d+10),g.stroke()))},s.prototype.destroyInstance=function(a){var b=this.activeInstances[a];b&&(b.destroy(),delete this.activeInstances[a])},s.prototype.init=function(a){this.activeInstances[a]=new r(a)},new s});